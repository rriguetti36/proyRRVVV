<main class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="h4 mb-4 text-primary fw-bold">
                üìÇ Simulador de estudios de Cotizaci√≥n
            </h1>
            <!-- Wizard -->
            <div class="card shadow">
                <div class="card-body">
                    <div id="wizard">
                        <!-- Paso 1: Asegurado -->
                        <div class="wizard-step active" id="step1">
                            <h5>Datos del Asegurado</h5>
                            <hr>
                            <form id="formAsegurado">
                                <div class="row">
                                    <!-- Tipo Documento -->
                                    <div class="col-md-2 mb-3">
                                        <label for="tipoDoc">Tipo Documento</label>
                                        <select class="form-control" id="aseTipoDoc" name="aseTipoDoc">
                                            <option value="">-- Seleccione --</option>
                                            <% tipodoc.forEach(function(doc) { %>
                                                <option value="<%= doc.v_cod %>">
                                                    <%= doc.v_nombre %>
                                                </option>
                                                <% }) %>
                                        </select>
                                        <!-- <select class="form-control" id="tipoDoc" required>
                                            <option value="">-- Seleccione --</option>
                                            <option value="DNI">DNI</option>
                                            <option value="CE">Carn√© Extranjer√≠a</option>
                                            <option value="PAS">Pasaporte</option>
                                        </select> -->
                                    </div>

                                    <!-- N√∫mero Documento -->
                                    <div class="col-md-2 mb-3">
                                        <label for="numDoc">N√∫m. Documento</label>
                                        <input type="text" class="form-control" id="aseNumDoc" required>
                                    </div>

                                    <!-- CUSPP -->
                                    <div class="col-md-2 mb-3">
                                        <label for="cuspp">CUSPP</label>
                                        <input type="text" class="form-control" id="aseCuspp">
                                    </div>
                                </div>

                                <div class="row">
                                    <!-- Nombres -->
                                    <div class="col-md-4 mb-3">
                                        <label for="nombres">Nombres</label>
                                        <input type="text" class="form-control" id="aseNombres">
                                    </div>

                                    <!-- Apellido Paterno -->
                                    <div class="col-md-4 mb-3">
                                        <label for="apellidoPat">Apellido Paterno</label>
                                        <input type="text" class="form-control" id="aseApellidoPat">
                                    </div>

                                    <!-- Apellido Materno -->
                                    <div class="col-md-4 mb-3">
                                        <label for="apellidoMat">Apellido Materno</label>
                                        <input type="text" class="form-control" id="aseApellidoMat">
                                    </div>
                                </div>

                                <div class="row">
                                    <!-- Departamento -->
                                    <div class="col-md-2 mb-3">
                                        <label for="departamento">Departamento</label>
                                        <select class="form-control" id="aseDepartamento">
                                            <option value="">-- Seleccione --</option>
                                        </select>
                                    </div>

                                    <!-- Provincia -->
                                    <div class="col-md-2 mb-3">
                                        <label for="provincia">Provincia</label>
                                        <select class="form-control" id="aseProvincia">
                                            <option value="">-- Seleccione --</option>
                                        </select>
                                    </div>

                                    <!-- Distrito -->
                                    <div class="col-md-2 mb-3">
                                        <label for="distrito">Distrito</label>
                                        <select class="form-control" id="aseDistrito">
                                            <option value="">-- Seleccione --</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="row">
                                    <!-- Sexo -->
                                    <div class="col-md-2 mb-3">
                                        <label for="sexo">Sexo</label>
                                        <select class="form-control" id="aseSexo" name="aseSexo">
                                            <option value="">-- Seleccione --</option>
                                            <% tiposex.forEach(function(doc) { %>
                                                <option value="<%= doc.v_cod %>">
                                                    <%= doc.v_nombre %>
                                                </option>
                                                <% }) %>
                                        </select>
                                        <!-- <select class="form-control" id="sexo">
                                            <option value="">-- Seleccione --</option>
                                            <option value="M">Masculino</option>
                                            <option value="F">Femenino</option>
                                        </select> -->
                                    </div>

                                    <!-- Fecha Nacimiento -->
                                    <div class="col-md-2 mb-3">
                                        <label for="fechaNac">Fecha Nacimiento</label>
                                        <input type="date" class="form-control" id="aseFechaNac">
                                    </div>

                                    <!-- AFP -->
                                    <div class="col-md-2 mb-3">
                                        <label for="afp">AFP</label>
                                        <select class="form-control" id="aseAfp" name="aseAfp">
                                            <option value="">-- Seleccione --</option>
                                            <% tipoAfp.forEach(function(doc) { %>
                                                <option value="<%= doc.v_cod %>">
                                                    <%= doc.v_nombre %>
                                                </option>
                                                <% }) %>
                                        </select>
                                        <!-- <select class="form-control" id="afp">
                                            <option value="">-- Seleccione --</option>
                                            <option value="PRIMA">PRIMA</option>
                                            <option value="INTEGRA">INTEGRA</option>
                                            <option value="HABITAT">HABITAT</option>
                                        </select> -->
                                    </div>

                                    <!-- Tipo de Pensi√≥n -->
                                    <div class="col-md-2 mb-3">
                                        <label for="pension">Tipo de Pensi√≥n</label>
                                        <!-- <select class="form-control" id="pension" name="pension">
                                            <option value="">-- Seleccione --</option>
                                            <% tipoPen.forEach(function(doc) { %>
                                                <option value="<%= doc.v_cod %>">
                                                    <%= doc.v_nombre %>
                                                </option>
                                                <% }) %>
                                        </select> -->
                                        <select class="form-control" id="asePension" name="asePension">
                                            <option value="">-- Seleccione --</option>
                                            <option value="J">JUBILACION</option>
                                            <option value="I">INVALIDEZ</option>
                                            <option value="S">SOBREVIVECNIA</option>
                                        </select>
                                    </div>

                                    <!-- Tipo de invalidez -->
                                    <div class="col-md-2 mb-3">
                                        <label for="pension">Tipo de Invalidez</label>
                                        <select class="form-control" id="aseInvalidez" name="aseInvalidez">
                                            <option value="">-- Seleccione --</option>
                                            <% tipoInv.forEach(function(doc) { %>
                                                <option value="<%= doc.v_cod %>">
                                                    <%= doc.v_nombre %>
                                                </option>
                                                <% }) %>
                                        </select>
                                    </div>

                                    <!-- CIC -->
                                    <div class="col-md-2 mb-3">
                                        <label for="cic">CIC</label>
                                        <input type="text" class="form-control" id="aseCic">
                                    </div>
                                </div>



                                <div class="row">
                                    <!-- Fecha Devengue -->
                                    <div class="col-md-2 mb-3">
                                        <label for="fechaDev">Fecha Devengue</label>
                                        <input type="date" class="form-control" id="aseFechaDev">
                                    </div>

                                    <!-- Fecha Devengue Solicitud -->
                                    <div class="col-md-2 mb-3">
                                        <label for="fechaDevSol">Devengue Solicitud</label>
                                        <input type="date" class="form-control" id="aseFechaDevSol">
                                    </div>

                                    <!-- Gasto Sepelio -->
                                    <div class="col-md-2 mb-3">
                                        <label for="gastoSep">Gasto Sepelio</label>
                                        <input type="text" class="form-control" id="gastoSep" value="<%= gasSep %>"
                                            disabled>
                                    </div>

                                    <!-- Tipo de Cambio -->
                                    <div class="col-md-2 mb-3">
                                        <label for="tipoCambio">Tipo Cambio</label>
                                        <input type="text" class="form-control" id="tipoCambio" value="<%= tipCam %>"
                                            disabled>
                                    </div>
                                </div>
                                <input type="hidden" id="GasEmi" name="GasEmi" value="<%= Gastos.Gastosemi %>">
                                <input type="hidden" id="GasAdm" name="GasAdm" value="<%= Gastos.Gastosmant %>">
                                <input type="hidden" id="GasImp" name="GasImp" value="<%= Gastos.Impuestos %>">

                            </form>
                            <button class="btn btn-primary float-end nextBtn">Siguiente</button>
                        </div>

                        <!-- Paso 2: Beneficiarios -->
                        <div class="wizard-step d-none" id="step2">
                            <h5>Registro de Beneficiarios</h5>
                            <hr>

                            <!-- Bot√≥n para abrir modal -->
                            <button class="btn btn-sm btn-primary mb-3" data-bs-toggle="modal"
                                data-bs-target="#modalBeneficiario">
                                + Agregar Beneficiario
                            </button>

                            <!-- Tabla de beneficiarios -->
                            <div class="table-responsive"
                                style="max-height: 500px; overflow-y: auto; overflow-x: auto;">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-sm text-center" id="tablaBeneficiarios">
                                        <thead class="table-light">
                                            <tr>
                                                <th>#</th>
                                                <th>Parentesco</th>
                                                <th>Sexo</th>
                                                <th>Fecha Nac.</th>
                                                <th>Invalidez</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Aqu√≠ se insertar√°n din√°micamente los beneficiarios -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>


                            <button class="btn btn-secondary prevBtn">Anterior</button>
                            <button class="btn btn-primary float-end nextBtn">Siguiente</button>
                        </div>

                        <!-- Paso 3: Modalidades -->
                        <div class="wizard-step d-none" id="step3">
                            <h5>Modalidades de Cotizaci√≥n</h5>
                            <hr>
                            <button class="btn btn-sm btn-primary mb-3" data-bs-toggle="modal"
                                data-bs-target="#modalAgregarModalidad">
                                + Agregar Modalidad
                            </button>
                            <button class="btn btn-sm btn-primary mb-3" id="btnModalidasDef">
                                + Agregar Paquete modalidades
                            </button>

                            <div class="table-responsive">
                                <table class="table table-bordered table-hover align-middle text-center"
                                    id="tablaModalidades">
                                    <thead class="table-light">
                                        <tr>
                                            <th>#</th>
                                            <th>Tipo de Renta</th>
                                            <th>Moneda</th>
                                            <th>Diferido</th>
                                            <th>Garantizado</th>
                                            <th>Gratificaci√≥n</th>
                                            <th>Primer Tramo</th>
                                            <th>Segundo Tramo</th>
                                            <th>% Renta AFP</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Se insertan din√°micamente -->
                                    </tbody>
                                </table>
                            </div>
                            <br>
                            <button class="btn btn-sm btn-primary mb-3 float-end" id="btnCalcular">Calcular</button>
                            <br>
                            <br>
                            <h5>Resultados</h5>
                            <hr>
                            <div class="table-responsive">
                                <table class="table table-bordered" id="tablaResultados">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>ID Mod</th>
                                            <th>Pension Referencia</th>
                                            <th>Pension AFP</th>
                                            <th>Pension CIA</th>
                                            <th>Prima AFP</th>
                                            <th>Prima CIA</th>
                                            <th>Tasa VTA</th>
                                            <th>Tasa TCI</th>
                                            <th>Tasa TCE</th>
                                            <th>Tasa TIR</th>
                                            <th>Perdida</th>
                                            <th>Resultados Pen</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Aqu√≠ se llenar√° din√°micamente -->
                                    </tbody>
                                </table>
                            </div>
                            <button class="btn btn-secondary prevBtn">Anterior</button>
                            <button class="btn btn-secondary float-end" id="btnGuardar">Guardar y Enviar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Modal Beneficiario -->
<div class="modal fade" id="modalBeneficiario" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Registro de Beneficiario</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <form id="formBeneficiario" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Tipo Documento</label>
                        <select class="form-control" id="benTipoDoc" name="benTipoDoc">
                            <option value="">-- Seleccione --</option>
                            <% tipodoc.forEach(function(doc) { %>
                                <option value="<%= doc.v_cod %>">
                                    <%= doc.v_nombre %>
                                </option>
                                <% }) %>
                        </select>
                        <!-- <select class="form-control" id="benTipoDoc">
                            <option value="">-- Seleccione --</option>
                            <option value="DNI">DNI</option>
                            <option value="CE">Carn√© Extranjer√≠a</option>
                        </select> -->
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">N√∫m. Documento</label>
                        <input type="text" class="form-control" id="benNumDoc">
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Parentesco</label>
                        <select class="form-control" id="benParentesco" name="benParentesco">
                            <option value="">-- Seleccione --</option>
                            <% tipoPar.forEach(function(doc) { %>
                                <option value="<%= doc.v_cod %>">
                                    <%= doc.v_nombre %>
                                </option>
                                <% }) %>
                        </select>
                        <!-- <select class="form-control" id="benParentesco">
                            <option value="">-- Seleccione --</option>
                            <option value="conyuge">C√≥nyuge</option>
                            <option value="hijo">Hijo</option>
                        </select> -->
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Fecha Nacimiento</label>
                        <input type="date" class="form-control" id="benFechaNac">
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Sexo</label>
                        <select class="form-control" id="benSexo" name="benSexo">
                            <option value="">-- Seleccione --</option>
                            <% tiposex.forEach(function(doc) { %>
                                <option value="<%= doc.v_cod %>">
                                    <%= doc.v_nombre %>
                                </option>
                                <% }) %>
                        </select>
                        <!-- <select class="form-control" id="benSexo">
                            <option value="">-- Seleccione --</option>
                            <option value="M">Masculino</option>
                            <option value="F">Femenino</option>
                        </select> -->
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Situaci√≥n Invalidez</label>
                        <select class="form-control" id="benInvalidez">
                            <option value="">-- Seleccione --</option>
                            <option value="1">Sano</option>
                            <option value="2">Invalido</option>
                        </select>
                    </div>
                </form>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-success" id="btnGuardarBeneficiario">Aceptar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para agregar modalidad -->
<div class="modal fade" id="modalAgregarModalidad" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Agregar Modalidad</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <form id="formModalidad" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Moneda</label>
                        <select class="form-control" id="moneda" name="moneda">
                            <option value="">-- Seleccione --</option>
                            <% tipoMon.forEach(function(doc) { %>
                                <option value="<%= doc.v_cod %>">
                                    <%= doc.v_nombre %>
                                </option>
                                <% }) %>
                        </select>
                        <!--  <select id="moneda" class="form-control" required>
                            <option value="">-- Seleccione --</option>
                            <option value="PEN">Soles</option>
                            <option value="USD">D√≥lares</option>
                        </select> -->
                    </div>
                    <!-- 
                    <div class="col-md-4">
                        <label class="form-label">Modalidad</label>
                        <select class="form-control" id="modalidad" name="modalidad">
                            <option value="">-- Seleccione --</option>
                            <% tipoMod.forEach(function(doc) { %>
                                <option value="<%= doc.v_cod %>">
                                    <%= doc.v_nombre %>
                                </option>
                                <% }) %>
                        </select>
                    </div> -->

                    <div class="col-md-8">
                        <label class="form-label">Tipo de Renta</label>
                        <select class="form-control" id="tipoRenta" name="tipoRenta">
                            <option value="">-- Seleccione --</option>
                            <% tipoRen.forEach(function(doc) { %>
                                <option value="<%= doc.v_cod %>">
                                    <%= doc.v_nombre %>
                                </option>
                                <% }) %>
                        </select>

                        <!-- <select id="tipoRenta" class="form-control" required>
                            <option value="">-- Seleccione --</option>
                            <option value="Directa">Directa</option>
                            <option value="Conyugal">Conyugal</option>
                        </select> -->
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Periodo Diferido</label>
                        <select id="periodoDiferido" name="periodoDiferido" class="form-control">
                            <option value="">-- Seleccione --</option>
                            <option value="1">1 A√±os</option>
                            <option value="2">2 A√±os</option>
                            <option value="3">3 A√±os</option>
                            <option value="4">4 A√±os</option>
                            <option value="5">5 A√±os</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Periodo Garantizado</label>
                        <select id="periodoGarantizado" name="periodoGarantizado" class="form-control">
                            <option value="">-- Seleccione --</option>
                            <option value="10">10 a√±os</option>
                            <option value="15">15 a√±os</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Gratificaci√≥n</label>
                        <select id="gratificacion" class="form-control">
                            <option value="">-- Seleccione --</option>
                            <option value="S">S√≠</option>
                            <option value="N">No</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Primer Tramo</label>
                        <select id="primerTramo" class="form-control">
                            <option value="">-- Seleccione --</option>
                            <option value="1">1 a√±os</option>
                            <option value="2">2 a√±os</option>
                            <option value="3">3 a√±os</option>
                            <option value="4">4 a√±os</option>
                            <option value="5">5 a√±os</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Segundo Tramo</label>
                        <select id="segundoTramo" class="form-control">
                            <option value="">-- Seleccione --</option>
                            <option value="50">50 %</option>
                            <option value="100">100 %</option>
                            <option value="200">200 %</option>
                        </select>
                    </div>

                    <!-- <div class="col-md-4">
                        <label class="form-label">% Comisi√≥n AFP</label>
                        <input type="text" id="comisionAFP" class="form-control" placeholder="%" disabled>
                    </div> -->
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="btnGuardarModalidad" class="btn btn-success">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Loader oculto por defecto -->
<div id="loader" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; 
     background: rgba(255,255,255,0.7); z-index:9999; text-align:center; padding-top:20%;">
    <div class="spinner-border text-primary" role="status" style="width: 5rem; height: 5rem;">
        <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-3">Procesando tu solicitud, por favor espera...</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // Navegaci√≥n del wizard
    document.querySelectorAll(".nextBtn").forEach(btn => {
        btn.addEventListener("click", function () {
            let currentStep = this.closest(".wizard-step");
            let nextStep = currentStep.nextElementSibling;
            if (nextStep) {
                currentStep.classList.add("d-none");
                nextStep.classList.remove("d-none");
            }
        });
    });

    document.querySelectorAll(".prevBtn").forEach(btn => {
        btn.addEventListener("click", function () {
            let currentStep = this.closest(".wizard-step");
            let prevStep = currentStep.previousElementSibling;
            if (prevStep) {
                currentStep.classList.add("d-none");
                prevStep.classList.remove("d-none");
            }
        });
    });

    let beneficiarios = [];
    let countBeneficiario = 1;

    // Guardar Beneficiarios
    document.getElementById("btnGuardarBeneficiario").addEventListener("click", () => {
        countBeneficiario++;
        const data = {
            IdBeneficiario: countBeneficiario,
            Parentesco: parseFloat(document.getElementById("benParentesco").value),
            Genero: parseFloat(document.getElementById("benSexo").value),
            FechaNacimiento: document.getElementById("benFechaNac").value,
            TipoInvalidez: parseFloat(document.getElementById("benInvalidez").value)
        };
        //muestra las descripciones
        let selectPar = document.getElementById("benParentesco");
        data.DescriTipoPar = selectPar.options[selectPar.selectedIndex].text;
        let selectSex = document.getElementById("benSexo");
        data.DescriTipoSex = selectSex.options[selectSex.selectedIndex].text;
        let selectInv = document.getElementById("benInvalidez");
        data.DescriTipoInv = selectInv.options[selectInv.selectedIndex].text;

        if (!data.Parentesco || !data.Genero || !data.FechaNacimiento || !data.TipoInvalidez) {
            alert("Complete los campos obligatorios.");
            return;
        }

        beneficiarios.push(data);
        renderTablaBeneficiarios();
        document.getElementById("formBeneficiario").reset();
        bootstrap.Modal.getInstance(document.getElementById("modalBeneficiario")).hide();
    });

    function renderTablaBeneficiarios() {
        const tbody = document.querySelector("#tablaBeneficiarios tbody");
        tbody.innerHTML = "";
        beneficiarios.forEach((b, index) => {
            tbody.innerHTML += `
        <tr>
            <td>${index + 1}</td>
            <td>${b.DescriTipoPar}</td>
            <td>${b.DescriTipoSex}</td>
            <td>${b.FechaNacimiento}</td>
            <td>${b.DescriTipoInv}</td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="eliminarbeneficiarios(${b.IdBeneficiario})">
                <i class="fa fa-trash"></i>
                </button>
            </td>
        </tr>
      `;
        });
    }

    function eliminarbeneficiarios(id) {
        beneficiarios = beneficiarios.filter(m => m.id !== id);
        renderTablaModalidades();
    }


    let modalidades = [];
    let countModalidad = 0;

    // Guardar Modalidad
    document.getElementById("btnGuardarModalidad").addEventListener("click", async () => {
        countModalidad++;
        const data = {
            IdModalidad: countModalidad,
            Moneda: parseFloat(document.getElementById("moneda").value),
            PeriodoDiferido: parseFloat(document.getElementById("periodoDiferido").value || 0),
            PeriodoGarantizado: parseFloat(document.getElementById("periodoGarantizado").value || 0),
            Gratificacion: document.getElementById("gratificacion").value,
            PrimerTramo: parseFloat(document.getElementById("primerTramo").value || 0),
            SegundoTramo: parseFloat(document.getElementById("segundoTramo").value || 0),
            //modalidad: parseFloat(document.getElementById("modalidad").value),
            //tipoRenta: parseFloat(document.getElementById("tipoRenta").value),
            //comisionAFP: document.getElementById("comisionAFP").value
        };
        //trae las tasas y topes de cada modalidad
        const MontoCIC = parseFloat(document.getElementById("aseCic").value || 0);
        const TipoPension = document.getElementById("asePension").value;
        const IdAfp = document.getElementById("aseAfp").value;
        const body = {
            moneda: data.moneda,
            montoCIC: MontoCIC,
            prestacion: TipoPension,
            afp: IdAfp
        };
        const response = await fetch("http://localhost:3000/cotizador/api/tasasInd", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(body)
        });
        const result = await response.json();
        data.TasaRentaAFP = parseFloat(result.prcafp || 0);
        data.RentaTemp = 50;
        data.tasaanclaje = parseFloat(result.valtac || 0);
        data.tasaventaprom = parseFloat(result.valpro || 0);
        data.tasaventa = parseFloat(result.valvta || 0);
        data.tasatirtope = parseFloat(result.valtir || 0);
        data.tasaperdidatope = parseFloat(result.valper || 0);
        data.comision = parseFloat(result.comision || 0);

        //muestra las descripciones
        let selectMon = document.getElementById("moneda");
        data.DescriTipoMoneda = selectMon.options[selectMon.selectedIndex].text;
        /* let selectMod = document.getElementById("modalidad");
        data.DescriTipoModalidad = selectMod.options[selectMod.selectedIndex].text; */
        let selectRen = document.getElementById("tipoRenta");
        data.DescriTipoRenta = selectRen.options[selectRen.selectedIndex].text;

        if (!data.Moneda) {
            alert("Complete los campos obligatorios.");
            return;
        }

        modalidades.push(data);
        console.log(modalidades);
        renderTablaModalidades();
        document.getElementById("formModalidad").reset();
        bootstrap.Modal.getInstance(document.getElementById("modalAgregarModalidad")).hide();
    });

    function renderTablaModalidades() {
        const tbody = document.querySelector("#tablaModalidades tbody");
        tbody.innerHTML = "";
        modalidades.forEach((m, index) => {
            tbody.innerHTML += `
        <tr>
          <td>${index + 1}</td>
          <td>${m.DescriTipoRenta}</td>
          <td>${m.DescriTipoMoneda}</td>
          <td>${m.PeriodoDiferido}</td>
          <td>${m.PeriodoGarantizado}</td>
          <td>${m.Gratificacion}</td>
          <td>${m.PrimerTramo}</td>
          <td>${m.SegundoTramo}</td>
          <td>${m.TasaRentaAFP}%</td>
          <td>
            <button class="btn btn-danger btn-sm" onclick="eliminarModalidad(${m.IdModalidad})">
              <i class="fa fa-trash"></i>
            </button>
          </td>
        </tr>
      `;
        });
    }

    function eliminarModalidad(id) {
        modalidades = modalidades.filter(m => m.id !== id);
        renderTablaModalidades();
    }

    // Arrays globales para almacenar la info



    // üëâ aqu√≠ deber√≠as tener tus funciones que van haciendo push
    // beneficiarios.push({...})
    // modalidades.push({...})

    document.getElementById("btnCalcular").addEventListener("click", async () => {

        const loader = document.getElementById("loader");
        loader.style.display = "block"; // üëà Mostrar loader
        await new Promise(r => setTimeout(r, 50));
        // --- Datos del asegurado (ejemplo: tomados de inputs) ---
        const asegurado = {
            IdBeneficiario: 1,
            TipoInvalidez: parseFloat(document.getElementById("aseInvalidez").value),
            FechaNacimiento: document.getElementById("aseFechaNac").value,
            Genero: parseFloat(document.getElementById("aseSexo").value),
            ComisionAFP: 0,
            TipoPension: document.getElementById("asePension").value,
            FechaDevengue: document.getElementById("aseFechaDev").value,
            FechaDevengueSolicitud: document.getElementById("aseFechaDevSol").value
        };

        // --- Datos generales ---
        const payload = {
            IdoperacionSbs: 0,
            Cliente: "01",
            TipoCambio: parseFloat(document.getElementById("tipoCambio").value || 0),
            GastoSepelio: parseFloat(document.getElementById("gastoSep").value || 0),
            MontoCIC: parseFloat(document.getElementById("aseCic").value || 0),
            Licencia: "",
            Gastos: {
                Gastosmant: parseFloat(document.getElementById("GasAdm").value || 0),
                Gastosemi: parseFloat(document.getElementById("GasEmi").value || 0),
                Porcentajedeuda: 0,
                Impuestos: parseFloat(document.getElementById("GasImp").value || 0)
            },
            Asegurado: asegurado,
            Beneficiario: beneficiarios, // tu array construido en el paso 2
            Modalidad: modalidades       // tu array construido en el paso 3
        };

        console.log("üì§ Enviando JSON:", payload);

        try {
            fetch("http://localhost:3000/auth/token", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ clientId: "cliente1", clientSecret: "secret123" })
            })
                .then(res => res.json())
                .then(data => {
                    const token = data.token;

                    // 2. Usar el token en calcula simulador
                    return fetch("http://localhost:3000/rutinarv/calcular", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${token}`
                        },
                        body: JSON.stringify(payload)
                    })
                        .then(res => res.json())
                        .then(resultadoFinal => {
                            console.log("‚úÖ Respuesta backend:", resultadoFinal);
                            //alert("Cotizaci√≥n calculada correctamente");
                            // üëá Reemplazamos el alert por un modal visual
                            Swal.fire({
                                title: "¬°√âxito!",
                                text: "Cotizaci√≥n calculada correctamente",
                                icon: "success",
                                confirmButtonText: "Aceptar",
                                confirmButtonColor: "#3085d6"
                            });

                            const tbody = document.querySelector("#tablaResultados tbody");
                            tbody.innerHTML = ""; // Limpiamos tabla previa

                            // Iteramos sobre cada item del array
                            resultadoFinal.forEach(item => {
                                const fila = document.createElement("tr");

                                // Validamos resultadospen
                                const resultadosPenHTML = Array.isArray(item.resultadospen)
                                    ? item.resultadospen.map(rp => `
                <tr>
                    <td>${rp.id}</td>
                    <td>${rp.prc}</td>
                    <td>${rp.pension}</td>
                </tr>
            `).join("")
                                    : `<tr><td colspan="3">No hay datos</td></tr>`;

                                fila.innerHTML = `
            <td>${item.idmod ?? ""}</td>
            <td>${item.penref ?? ""}</td>
            <td>${item.penafp ?? ""}</td>
            <td>${item.pencia ?? ""}</td>
            <td>${item.primaafp ?? ""}</td>
            <td>${item.primacia ?? ""}</td>
            <td>${item.tasavta ?? ""}</td>
            <td>${item.tasaTci ?? ""}</td>
            <td>${item.tasaTce ?? ""}</td>
            <td>${item.tasaTir ?? ""}</td>
            <td>${item.perdida ?? ""}</td>
            <td>
                <table class="table table-sm table-borderless mb-0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>%</th>
                            <th>Pensi√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${resultadosPenHTML}
                    </tbody>
                </table>
            </td>
        `;

                                tbody.appendChild(fila);
                            });
                        })
                })
        } catch (error) {
            console.error("‚ùå Error:", error);
            //alert("Error al enviar la cotizaci√≥n");
            Swal.fire({
                title: "Error",
                text: "Ocurri√≥ un problema al enviar la cotizaci√≥n",
                icon: "error",
                confirmButtonText: "Cerrar",
                confirmButtonColor: "#d33"
            });
        } finally {
            loader.style.display = "none"; // üëà Ocultar loader siempre
        }
    });

    document.addEventListener('DOMContentLoaded', () => {

        const departamento = document.getElementById('aseDepartamento');
        const provincia = document.getElementById('aseProvincia');
        const distrito = document.getElementById('aseDistrito');

        // 1. Cargar regiones al inicio
        fetch('/cotizador/api/regiones')
            .then(res => res.json())
            .then(data => {
                data.forEach(r => {
                    const option = document.createElement('option');
                    option.value = r.id;
                    option.textContent = r.v_nombre;
                    departamento.appendChild(option);
                });
            });

        // 2. Al cambiar regi√≥n -> provincias
        departamento.addEventListener('change', () => {
            const idRegion = departamento.value;
            provincia.innerHTML = '<option value="">-- Seleccione --</option>';
            distrito.innerHTML = '<option value="">-- Seleccione --</option>';
            if (!idRegion) return;

            fetch(`/cotizador/api/provincias/${idRegion}`)
                .then(res => res.json())
                .then(data => {
                    data.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = p.v_nombre;
                        provincia.appendChild(option);
                    });
                });
        });

        // 3. Al cambiar provincia -> distritos
        provincia.addEventListener('change', () => {
            const idProvincia = provincia.value;
            distrito.innerHTML = '<option value="">-- Seleccione --</option>';
            if (!idProvincia) return;

            fetch(`/cotizador/api/distritos/${idProvincia}`)
                .then(res => res.json())
                .then(data => {
                    data.forEach(d => {
                        const option = document.createElement('option');
                        option.value = d.id;
                        option.textContent = d.v_nombre;
                        distrito.appendChild(option);
                    });
                });
        });

        // 4. Al elegir un distrito -> autocompletar provincia y regi√≥n
        distrito.addEventListener('change', () => {
            const idDistrito = distrito.value;
            if (!idDistrito) return;

            fetch(`/cotizador/api/distrito-info/${idDistrito}`)
                .then(res => res.json())
                .then(info => {
                    provincia.value = info.idProvincia;
                    departamento.value = info.idRegion;
                });
        });

    });
</script>