<main class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="h4 mb-4 text-primary fw-bold">
                üìÇ Descargar XML ‚Üí Solicitudes Procesadas
            </h1>
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    Tabla de registros para la generaci√≥n de archivos
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table id="tablaArchivos" class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>N¬∞ Archivo</th>
                                    <th>Nombre del Archivo</th>
                                    <th>Fecha Envio</th>
                                    <th>Fecha Cierre</th>
                                    <th>NroInicial</th>
                                    <th>NroFinal</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                    <!-- <div class="mt-3 d-flex justify-content-end gap-2">
                        <button class="btn btn-info">üì§ Exportar</button>
                        <button class="btn btn-success">‚öôÔ∏è Generar</button>
                    </div> -->
                </div>
            </div>
            

        </div>
    </div>
</main>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

<script>
    $(document).ready(function () {
        $('#tablaArchivos').DataTable({
            ajax: {
                url: "http://localhost:3000/cotizador/api/solicitudes",
                dataSrc: "data"
            },
            columns: [
                {
                    data: "id_estado",
                    render: function (data) {
                        let color = "red";
                        if (data === 1) color = "green";
                        if (data === 2) color = "orange";
                        return `<span style="display:inline-block;width:16px;height:16px;border-radius:50%;background:${color};"></span>`;
                    }
                },
                { data: "id" },
                { data: "v_descripcion" },
                { data: "fec_envio" },
                { data: "fec_cierre" },
                { data: "inisol" },
                { data: "finsol" },
                {
                    data: null,
                    title: 'Acciones',
                    orderable: false,
                    searchable: false,
                    render: function (data, type, row) {
                        return `
                                <button class="btn btn-sm btn-primary" onclick="generaexportaxls('${row.id}')"><i class="fas fa-file-excel"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="generadescargaxml('${row.id}')"><i class="fas fa-file-code"></i></button>
                            `;
                    }
                }
            ],
            //scrollY: '300px',   // altura con scroll vertical
            //scrollCollapse: true,
            //pageLength: 10,
            //scrollX: true,      // scroll horizontal si hay muchas columnas
            //paging: false,      // opcional, puedes desactivar paginaci√≥n
            language: {
                url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json"
            },
            pageLength: 10,
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'excelHtml5',
                    text: '<i class="fas fa-file-excel"></i>',
                    className: 'btn btn-success',
                    titleAttr: 'Exportar a Excel'
                },
                {
                    extend: 'csvHtml5',
                    text: '<i class="fas fa-file-code"></i>',
                    className: 'btn btn-secondary',
                    titleAttr: 'Exportar a XML'
                }
            ]
        });
    });

    async function generadescargaxml(id) {
        try {
            // 1. Pedir el token primero
            const authResp = await fetch("http://localhost:3000/auth/token", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ clientId: "cliente1", clientSecret: "secret123" })
            });
            const authData = await authResp.json();

            if (!authData.token) {
                alert("‚ùå No se pudo obtener token");
                return;
            }

            // 2. Llamar al servicio generaXMLsalida con el token
            const respuesta = await fetch("http://localhost:3000/rutinarv/generar-xml", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${authData.token}` // üëà enviar el token
                },
                body: JSON.stringify({ id_archivo: id })
            });

            if (!respuesta.ok) {
                const err = await respuesta.json();
                alert("‚ùå Error: " + err.mensaje);
                return;
            }

            // 3. Descargar archivo (igual que antes)
            //üëá aqu√≠ lo tratamos como archivo
            const blob = await respuesta.blob();
            const url = window.URL.createObjectURL(blob);

            const link = document.createElement("a");
            link.href = url;
            link.download = `cargaCot_${new Date().toISOString().slice(0, 10)}.xml`;
            document.body.appendChild(link);
            link.click();
            link.remove();

            window.URL.revokeObjectURL(url);
        } catch (error) {
            console.error("‚ùå Error en fetch:", error);
            alert("Error generando XML");
        }
    }


</script>