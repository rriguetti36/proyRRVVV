<main class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    Subir archivo XML
                </div>
                <div class="card-body">
                    <!-- Input file -->
                    <input type="file" id="xmlFile" accept=".xml" class="form-control">
                    <div class="input-group">
                        <textarea id="xmlMinificado" rows="10" class="form-control font-monospace bg-light"
                            placeholder="Aquí aparecerá el XML minificado..."></textarea>

                    </div>
                    <button type="button" class="btn btn-success" id="btnFetch">Procesar</button>
                    <h1>Resultados del XML</h1>

                    <div id="tablaResultados"></div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    document.getElementById("xmlFile").addEventListener("change", function (event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();

        reader.onload = function (e) {
            const xmlString = e.target.result;

            try {
                // Minificar XML (remueve saltos de línea y espacios extra)
                const xmlMin = xmlString.replace(/\s{2,}|\n|\r/g, "");
                document.getElementById("xmlMinificado").value = xmlMin;

                //agregarLog("✅ XML cargado y procesado correctamente.");
            } catch (error) {
                //agregarLog("❌ Error procesando XML: " + error.message);
            }
        };

        reader.readAsText(file);
    });

    // Procesar con fetch
    document.getElementById("btnFetch").addEventListener("click", async () => {
        try {
            const xmlContent = document.getElementById("xmlMinificado").value.trim();

            if (!xmlContent) {
                alert("⚠️ Pegue un XML antes de procesar.");
                return;
            }

            const res = await fetch("http://localhost:3000/cotizador/cargaresultado", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ xmlMinificado: xmlContent }),
            });

            if (!res.ok) {
                const errMsg = await res.text();
                throw new Error(errMsg || "Error en la petición");
            }

            const data = await res.json(); // ← ahora esperamos JSON
            const resultados = data.resultados || [];

            const container = document.getElementById("tablaResultados");

            if (resultados.length === 0) {
                container.innerHTML = "<p>No se encontraron resultados en el XML.</p>";
                return;
            }

            // Construir tabla dinámica
            let table = `
    <div class="table-responsive" style="max-height: 500px; overflow-y: auto; overflow-x: auto;">
        <table class="table table-striped table-bordered table-hover align-middle">
          <thead class="table-dark" style="position: sticky; top: 0; z-index: 2;">
            <tr>
              ${Object.keys(resultados[0])
                    .map((key) => `<th>${key}</th>`)
                    .join("")}
            </tr>
          </thead>
          <tbody>
            ${resultados
                    .map(
                        (row) =>
                            `<tr>${Object.values(row)
                                .map((val) => `<td>${val}</td>`)
                                .join("")}</tr>`
                    )
                    .join("")}
          </tbody>
        </table>
    </div>
      `;

            container.innerHTML = table;
        } catch (err) {
            console.error("❌ Error:", err);
            document.getElementById("tablaResultados").innerHTML =
                "<p style='color:red;'>❌ Error procesando el XML.</p>";
        }
    });
</script>